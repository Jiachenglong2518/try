<!-- 动态虚拟滚动 -->

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>动态高度虚拟滚动</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 800px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        padding: 20px;
        background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
        color: white;
        text-align: center;
      }

      .header h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.8;
        font-size: 14px;
      }

      .controls {
        padding: 15px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eaeaea;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }

      .stats {
        font-size: 14px;
        color: #6c757d;
      }

      .scroll-container {
        height: 400px;
        overflow-y: auto;
        position: relative;
        border-bottom: 1px solid #eaeaea;
      }

      .scroll-content {
        position: relative;
      }

      .item {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        position: absolute;
        width: 100%;
        transition: background-color 0.2s;
      }

      .item:hover {
        background-color: #f8f9fa;
      }

      .item-index {
        display: inline-block;
        width: 30px;
        height: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-weight: bold;
        font-size: 14px;
        flex-shrink: 0;
      }

      .item-content {
        flex: 1;
      }

      .item-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #343a40;
      }

      .item-desc {
        font-size: 13px;
        color: #6c757d;
        line-height: 1.4;
      }

      .footer {
        padding: 15px 20px;
        text-align: center;
        color: #6c757d;
        font-size: 13px;
      }

      .highlight {
        background-color: #e3f2fd !important;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 60px;
        color: #6c757d;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #4b6cb7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      button {
        background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: opacity 0.2s;
      }

      button:hover {
        opacity: 0.9;
      }

      input,
      select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .control-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .estimated-height {
        background-color: #fff3cd;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>动态高度虚拟滚动</h1>
        <p>支持不同高度项目的虚拟滚动实现</p>
      </div>

      <div class="controls">
        <div class="stats">
          总数据量: <span id="total-count">0</span> | 渲染项:
          <span id="render-count">0</span> | 可见项:
          <span id="visible-count">0</span>
        </div>
        <div class="control-group">
          <input
            type="number"
            id="data-size"
            placeholder="数据量"
            value="1000"
            min="100"
            max="10000"
          />
          <select id="content-type">
            <option value="mixed">混合内容</option>
            <option value="short">短内容</option>
            <option value="long">长内容</option>
          </select>
          <button id="generate-btn">生成数据</button>
        </div>
      </div>

      <div class="scroll-container" id="scroll-container">
        <div class="scroll-content" id="scroll-content"></div>
      </div>

      <div class="footer">
        滚动区域高度: 400px | 预估高度: 60-200px | 缓冲区: 5项
        <div class="estimated-height">
          注意: 初始使用预估高度，渲染后更新为实际高度
        </div>
      </div>
    </div>

    <script>
      class DynamicVirtualScroll {
        constructor(container, content, options = {}) {
          this.container = container;
          this.content = content;
          this.estimatedHeight = options.estimatedHeight || 80;
          this.buffer = options.buffer || 5;
          this.data = [];

          // 位置索引：记录每个项目的顶部位置和高度
          this.positionCache = [];
          this.totalHeight = 0;

          this.visibleCount = 0;
          this.startIndex = 0;
          this.endIndex = 0;

          // 用于防抖滚动事件
          this.scrollTimer = null;

          this.init();
        }

        init() {
          // 绑定滚动事件（使用防抖）
          this.container.addEventListener("scroll", () => {
            if (this.scrollTimer) {
              clearTimeout(this.scrollTimer);
            }
            this.scrollTimer = setTimeout(() => {
              this.handleScroll();
            }, 10);
          });

          // 初始渲染
          this.updateContentHeight();
          this.renderVisibleItems();
        }

        setData(newData) {
          this.data = newData;

          // 初始化位置缓存
          this.positionCache = [];
          let currentPosition = 0;

          for (let i = 0; i < this.data.length; i++) {
            this.positionCache[i] = {
              top: currentPosition,
              height: this.estimatedHeight,
              measured: false,
            };
            currentPosition += this.estimatedHeight;
          }

          this.totalHeight = currentPosition;
          this.updateContentHeight();
          this.renderVisibleItems();
        }

        updateContentHeight() {
          this.content.style.height = `${this.totalHeight}px`;
        }

        handleScroll() {
          this.renderVisibleItems();
        }

        // 二分查找找到起始索引
        findStartIndex(scrollTop) {
          let low = 0;
          let high = this.positionCache.length - 1;

          while (low <= high) {
            const mid = Math.floor((low + high) / 2);
            const midPosition = this.positionCache[mid].top;

            if (midPosition < scrollTop) {
              low = mid + 1;
            } else {
              high = mid - 1;
            }
          }

          return Math.max(0, low - 1);
        }

        renderVisibleItems() {
          // 计算可见区域
          const scrollTop = this.container.scrollTop;
          const containerHeight = this.container.clientHeight;

          // 使用二分查找找到起始索引
          this.startIndex = this.findStartIndex(scrollTop);
          this.endIndex = this.startIndex;

          // 计算结束索引
          let currentHeight = 0;
          for (let i = this.startIndex; i < this.positionCache.length; i++) {
            if (this.positionCache[i].top > scrollTop + containerHeight) {
              break;
            }
            this.endIndex = i;
          }

          // 添加缓冲区
          this.startIndex = Math.max(0, this.startIndex - this.buffer);
          this.endIndex = Math.min(
            this.data.length - 1,
            this.endIndex + this.buffer
          );

          this.visibleCount = this.endIndex - this.startIndex + 1;

          // 更新统计信息
          document.getElementById("render-count").textContent =
            this.visibleCount;
          document.getElementById("visible-count").textContent =
            this.endIndex - this.startIndex + 1 - this.buffer * 2;

          // 清空内容
          this.content.innerHTML = "";

          // 渲染可见项
          for (let i = this.startIndex; i <= this.endIndex; i++) {
            const item = this.createItem(this.data[i], i);
            this.content.appendChild(item);

            // 如果项目高度尚未测量，测量并更新位置缓存
            if (!this.positionCache[i].measured) {
              this.measureItem(i, item);
            }
          }
        }

        createItem(data, index) {
          const item = document.createElement("div");
          item.className = "item";
          item.style.top = `${this.positionCache[index].top}px`;
          item.setAttribute("data-index", index);

          item.innerHTML = `
                    <div class="item-index">${index + 1}</div>
                    <div class="item-content">
                        <div class="item-title">${data.title}</div>
                        <div class="item-desc">${data.description}</div>
                    </div>
                `;

          // 高亮当前项
          const scrollTop = this.container.scrollTop;
          const containerHeight = this.container.clientHeight;
          const itemTop = this.positionCache[index].top;
          const itemHeight = this.positionCache[index].height;

          if (
            itemTop <= scrollTop + containerHeight / 2 &&
            itemTop + itemHeight >= scrollTop + containerHeight / 2
          ) {
            item.classList.add("highlight");
          }

          return item;
        }

        measureItem(index, itemElement) {
          const measuredHeight = itemElement.offsetHeight;

          // 如果测量高度与预估高度不同，更新位置缓存
          if (Math.abs(measuredHeight - this.positionCache[index].height) > 1) {
            this.positionCache[index].height = measuredHeight;
            this.positionCache[index].measured = true;

            // 更新后续项目的位置
            this.updatePositionsFrom(index);

            // 重新渲染（因为位置可能已改变）
            this.renderVisibleItems();
          }
        }

        updatePositionsFrom(fromIndex) {
          let currentPosition =
            fromIndex > 0
              ? this.positionCache[fromIndex - 1].top +
                this.positionCache[fromIndex - 1].height
              : 0;

          for (let i = fromIndex; i < this.positionCache.length; i++) {
            this.positionCache[i].top = currentPosition;
            currentPosition += this.positionCache[i].height;
          }

          this.totalHeight = currentPosition;
          this.updateContentHeight();
        }

        // 滚动到指定位置
        scrollTo(index) {
          if (index >= 0 && index < this.positionCache.length) {
            this.container.scrollTop = this.positionCache[index].top;
          }
        }
      }

      // 生成模拟数据
      function generateData(count, contentType) {
        const titles = [
          "项目计划文档",
          "季度财务报告",
          "产品需求文档",
          "技术设计方案",
          "市场分析报告",
          "用户调研总结",
          "项目进度更新",
          "团队周报",
          "客户反馈汇总",
          "产品路线图",
        ];

        const shortDescriptions = [
          "这是一份简短文档。",
          "简要总结工作内容。",
          "记录了关键决策。",
          "包含基本信息和安排。",
          "提供了基础数据。",
        ];

        const longDescriptions = [
          "这是一份非常重要的文档，包含了极其详细的信息和大量数据。这份文档对于项目的成功至关重要，需要所有团队成员认真阅读和理解。文档中包含了多个章节，涵盖了从项目背景到具体实施方案的各个方面。",
          "这份报告全面总结了过去一段时间的工作成果和遇到的问题。我们分析了各项指标的表现，识别了成功因素和改进空间。报告还包含了详细的数据分析和可视化图表，帮助读者更好地理解当前状况。",
          "本文档记录了关键决策过程和最终确定的方向。我们考虑了多种方案，评估了各自的优缺点，最终选择了最适合当前情况的方案。决策过程中我们充分听取了各方意见，确保决策的科学性和可行性。",
          "这份文档包含了多个部门的协作内容和时间安排。我们详细规划了每个阶段的任务、负责人和截止日期，确保项目能够按时高质量完成。文档还包含了风险评估和应对策略，以应对可能出现的各种情况。",
          "本报告提供了详细的数据分析和可视化图表。我们收集了大量数据，运用先进的统计方法进行分析，得出了有价值的结论。这些结论将指导我们未来的工作方向和重点。报告还包含了与行业标杆的对比分析。",
        ];

        const mixedDescriptions = [...shortDescriptions, ...longDescriptions];

        const data = [];
        for (let i = 0; i < count; i++) {
          let descriptionPool;

          switch (contentType) {
            case "short":
              descriptionPool = shortDescriptions;
              break;
            case "long":
              descriptionPool = longDescriptions;
              break;
            default:
              descriptionPool = mixedDescriptions;
          }

          // 随机选择描述，创建不同高度的项目
          const descIndex = Math.floor(Math.random() * descriptionPool.length);

          data.push({
            title: `${titles[i % titles.length]} #${i + 1}`,
            description: descriptionPool[descIndex],
          });
        }

        return data;
      }

      // 初始化
      document.addEventListener("DOMContentLoaded", function () {
        const container = document.getElementById("scroll-container");
        const content = document.getElementById("scroll-content");
        const generateBtn = document.getElementById("generate-btn");
        const dataSizeInput = document.getElementById("data-size");
        const contentTypeSelect = document.getElementById("content-type");
        const totalCountEl = document.getElementById("total-count");

        // 创建虚拟滚动实例
        const virtualScroll = new DynamicVirtualScroll(container, content, {
          estimatedHeight: 80,
          buffer: 5,
        });

        // 初始生成数据
        function generateNewData() {
          const dataSize = parseInt(dataSizeInput.value) || 1000;
          if (dataSize < 100) {
            alert("数据量不能少于100");
            return;
          }

          if (dataSize > 10000) {
            alert("数据量不能超过10000");
            return;
          }

          const contentType = contentTypeSelect.value;

          // 显示加载状态
          content.innerHTML =
            '<div class="loading"><div class="spinner"></div>生成数据中...</div>';

          // 使用setTimeout模拟数据生成延迟
          setTimeout(() => {
            const data = generateData(dataSize, contentType);
            virtualScroll.setData(data);
            totalCountEl.textContent = dataSize.toLocaleString();
          }, 100);
        }

        // 绑定生成按钮事件
        generateBtn.addEventListener("click", generateNewData);

        // 初始生成数据
        generateNewData();

        // 添加键盘快捷键
        document.addEventListener("keydown", function (e) {
          if (e.ctrlKey && e.key === "r") {
            e.preventDefault();
            generateNewData();
          }
        });
      });
    </script>
  </body>
</html>
